<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Kalkulator Kompleks</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #121212;
    }

    .calculator {
      background: #1f1f1f;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
      width: 360px;
      color: #f1f1f1;
    }

    .calc-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .calc-title {
      font-size: 16px;
      font-weight: 600;
    }

    .memory-indicator {
      font-size: 12px;
      opacity: 0.8;
    }

    #display {
      width: 100%;
      padding: 12px 10px;
      font-size: 24px;
      border-radius: 10px;
      border: none;
      outline: none;
      text-align: right;
      background: #262626;
      color: #f1f1f1;
      margin-bottom: 10px;
    }

    .buttons {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
    }

    button {
      border: none;
      padding: 10px;
      font-size: 15px;
      border-radius: 8px;
      cursor: pointer;
      background: #2c2c2c;
      color: #f1f1f1;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.15s ease;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(0,0,0,0.6) inset;
    }

    button.operator {
      background: #3949ab;
    }

    button.equal {
      background: #ffb300;
      grid-column: span 2;
      font-weight: 600;
    }

    button.ac {
      background: #d32f2f;
    }

    button.fn {
      background: #424242;
      font-size: 13px;
    }

    button.memory {
      background: #37474f;
      font-size: 13px;
    }

    .history {
      max-height: 100px;
      overflow-y: auto;
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid #333;
      font-size: 12px;
      color: #bdbdbd;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .history-exp {
      opacity: 0.8;
    }

    .history-res {
      font-weight: 500;
    }

    /* Scrollbar kecil agar rapi */
    .history::-webkit-scrollbar {
      width: 4px;
    }
    .history::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="calculator">
    <div class="calc-header">
      <div class="calc-title">Kalkulator Kompleks</div>
      <div class="memory-indicator" id="memoryIndicator">Mem: 0</div>
    </div>
    <input type="text" id="display" placeholder="0" readonly />

    <div class="buttons">
      <!-- Baris fungsi ilmiah -->
      <button class="fn" onclick="appendToDisplay('sin(')">sin</button>
      <button class="fn" onclick="appendToDisplay('cos(')">cos</button>
      <button class="fn" onclick="appendToDisplay('tan(')">tan</button>
      <button class="fn" onclick="appendToDisplay('log(')">log</button>
      <button class="fn" onclick="appendToDisplay('ln(')">ln</button>

      <!-- Baris fungsi lain -->
      <button class="fn" onclick="appendToDisplay('√(')">√</button>
      <button class="fn" onclick="appendToDisplay('^')">xʸ</button>
      <button class="fn" onclick="square()">x²</button>
      <button class="fn" onclick="inverse()">1/x</button>
      <button class="fn" onclick="appendToDisplay('%')">%</button>

      <!-- Baris memori -->
      <button class="memory" onclick="memoryAdd()">M+</button>
      <button class="memory" onclick="memorySubtract()">M-</button>
      <button class="memory" onclick="memoryRecall()">MR</button>
      <button class="memory" onclick="memoryClear()">MC</button>
      <button class="fn" onclick="appendToDisplay('π')">π</button>

      <!-- Baris control -->
      <button class="ac" onclick="clearDisplay()">AC</button>
      <button onclick="backspace()">⌫</button>
      <button class="fn" onclick="appendToDisplay('(')">(</button>
      <button class="fn" onclick="appendToDisplay(')')">)</button>
      <button class="operator" onclick="appendToDisplay('/')">÷</button>

      <!-- Angka & operator -->
      <button onclick="appendToDisplay('7')">7</button>
      <button onclick="appendToDisplay('8')">8</button>
      <button onclick="appendToDisplay('9')">9</button>
      <button class="operator" onclick="appendToDisplay('*')">×</button>
      <button class="fn" onclick="appendToDisplay('e')">e</button>

      <button onclick="appendToDisplay('4')">4</button>
      <button onclick="appendToDisplay('5')">5</button>
      <button onclick="appendToDisplay('6')">6</button>
      <button class="operator" onclick="appendToDisplay('-')">−</button>
      <button class="fn" onclick="toggleSign()">±</button>

      <button onclick="appendToDisplay('1')">1</button>
      <button onclick="appendToDisplay('2')">2</button>
      <button onclick="appendToDisplay('3')">3</button>
      <button class="operator" onclick="appendToDisplay('+')">+</button>
      <button onclick="appendToDisplay('0')">0</button>

      <!-- Baris terakhir -->
      <button onclick="appendToDisplay('.')">.</button>
      <button class="equal" onclick="calculate()">=</button>
    </div>

    <div class="history" id="history"></div>
  </div>

  <script>
    const display = document.getElementById('display');
    const historyContainer = document.getElementById('history');
    const memoryIndicator = document.getElementById('memoryIndicator');

    let memory = 0;

    function appendToDisplay(value) {
      // Jika sebelumnya hasil error, clear dulu
      if (display.value === 'Error') display.value = '';
      display.value += value;
    }

    function clearDisplay() {
      display.value = '';
    }

    function backspace() {
      if (display.value === 'Error') {
        display.value = '';
      } else {
        display.value = display.value.slice(0, -1);
      }
    }

    function toggleSign() {
      if (!display.value) return;
      if (display.value.startsWith('-')) {
        display.value = display.value.slice(1);
      } else {
        display.value = '-' + display.value;
      }
    }

    function square() {
      if (!display.value) return;
      try {
        const val = safeEvaluate(display.value);
        display.value = val * val;
        addHistory(`${val}²`, display.value);
      } catch (e) {
        display.value = 'Error';
      }
    }

    function inverse() {
      if (!display.value) return;
      try {
        const val = safeEvaluate(display.value);
        if (val === 0) {
          display.value = 'Error';
          return;
        }
        display.value = 1 / val;
        addHistory(`1/(${val})`, display.value);
      } catch (e) {
        display.value = 'Error';
      }
    }

    function toRad(deg) {
      return deg * Math.PI / 180;
    }

    function preprocessExpression(exp) {
      // Ganti simbol-simbol agar bisa dihitung JavaScript
      let expr = exp;

      // Akar
      expr = expr.replace(/√\(/g, 'Math.sqrt(');

      // Konstanta
      expr = expr.replace(/π/g, 'Math.PI');

      // Penting: jangan asal ganti 'e' karena bisa merusak angka seperti '1e5'
      // Ganti ' e ' atau '(e' atau '+e' dst dengan Math.E
      expr = expr.replace(/(^|[^0-9a-zA-Z_])e([^0-9a-zA-Z_]|$)/g, '$1Math.E$2');

      // Trigonometri & log (dalam derajat untuk sin/cos/tan)
      expr = expr.replace(/sin\(/g, 'Math.sin(toRad(');
      expr = expr.replace(/cos\(/g, 'Math.cos(toRad(');
      expr = expr.replace(/tan\(/g, 'Math.tan(toRad(');

      // log basis 10
      expr = expr.replace(/log\(/g, 'Math.log10(');

      // ln (log natural)
      expr = expr.replace(/ln\(/g, 'Math.log(');

      // Pangkat ^ menjadi **
      expr = expr.replace(/\^/g, '**');

      // Persen: ubah "x%" menjadi (x/100)
      // contoh: 50% -> (50/100)
      expr = expr.replace(/([0-9.]+)%/g, '($1/100)');

      return expr;
    }

    function safeEvaluate(input) {
      const expr = preprocessExpression(input);

      // Cek karakter ilegal (hanya izinkan angka, operator, titik, kurung, huruf untuk fungsi)
      if (!/^[0-9+\-*/%.()eE^π√\sA-Za-z]*$/.test(input)) {
        throw new Error('Invalid characters');
      }

      // Gunakan Function sebagai pengganti eval (tetap harus hati-hati di aplikasi nyata)
      const fn = new Function('toRad', `return ${expr};`);
      return fn(toRad);
    }

    function calculate() {
      const expression = display.value;
      if (!expression) return;
      try {
        const result = safeEvaluate(expression);
        addHistory(expression, result);
        display.value = result;
      } catch (e) {
        console.error(e);
        display.value = 'Error';
      }
    }

    function addHistory(exp, res) {
      const item = document.createElement('div');
      item.className = 'history-item';

      const expSpan = document.createElement('span');
      expSpan.className = 'history-exp';
      expSpan.textContent = exp;

      const resSpan = document.createElement('span');
      resSpan.className = 'history-res';
      resSpan.textContent = res;

      item.appendChild(expSpan);
      item.appendChild(resSpan);
      historyContainer.prepend(item);
    }

    // Fungsi memori
    function memoryAdd() {
      if (!display.value || display.value === 'Error') return;
      try {
        const val = safeEvaluate(display.value);
        memory += val;
        updateMemoryIndicator();
      } catch (e) {
        display.value = 'Error';
      }
    }

    function memorySubtract() {
      if (!display.value || display.value === 'Error') return;
      try {
        const val = safeEvaluate(display.value);
        memory -= val;
        updateMemoryIndicator();
      } catch (e) {
        display.value = 'Error';
      }
    }

    function memoryRecall() {
      display.value = memory.toString();
    }

    function memoryClear() {
      memory = 0;
      updateMemoryIndicator();
    }

    function updateMemoryIndicator() {
      memoryIndicator.textContent = 'Mem: ' + memory;
    }
  </script>
</body>
</html>
